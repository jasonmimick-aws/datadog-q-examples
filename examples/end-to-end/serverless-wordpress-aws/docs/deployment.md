# Deployment Process for WordPress on ECS

This document outlines the deployment process for the serverless WordPress solution on AWS ECS, including initial deployment and updates after remediation.

## Initial Deployment

### Prerequisites
- AWS CLI configured with appropriate permissions
- Terraform installed
- Docker installed
- Datadog API and Application keys

### Deployment Steps

#### 1. Infrastructure Deployment

```bash
# Navigate to the infrastructure directory
cd setup/infrastructure

# Initialize Terraform
terraform init

# Review the deployment plan
terraform plan -var-file=production.tfvars

# Deploy the infrastructure
terraform apply -var-file=production.tfvars -auto-approve
```

#### 2. Datadog Integration Setup

```bash
# Navigate to the Datadog setup directory
cd ../datadog

# Set up Datadog API keys
export DATADOG_API_KEY="your-api-key"
export DATADOG_APP_KEY="your-app-key"

# Deploy Datadog dashboards and monitors
./setup_monitors.sh
```

#### 3. WordPress Configuration

```bash
# Navigate to the WordPress setup directory
cd ../wordpress

# Configure WordPress settings
./configure_wordpress.sh

# Verify the deployment
./verify_deployment.sh
```

## Deployment After Remediation

When deploying changes after remediation, follow these steps to ensure a smooth update process.

### 1. Review Remediation Report

Before deploying any changes, review the remediation report generated by the `remediate.sh` script to understand the changes being made.

```bash
# View the remediation report
cat /path/to/remediation_dir/remediation_report.md
```

### 2. Apply Infrastructure Changes

If the remediation involved infrastructure changes (e.g., scaling, resource updates):

```bash
# Navigate to the infrastructure directory
cd setup/infrastructure

# Apply the changes using Terraform
terraform apply -var-file=production.tfvars -auto-approve
```

### 3. Update ECS Service

If the remediation involved ECS service updates:

```bash
# Update the ECS service with the new task definition
aws ecs update-service \
  --cluster wordpress-cluster \
  --service wordpress \
  --task-definition wordpress:latest \
  --force-new-deployment
```

### 4. Apply WordPress Configuration Changes

If the remediation involved WordPress configuration changes:

```bash
# Apply WordPress configuration changes
./scripts/update_wordpress_config.sh

# Verify the changes
./scripts/verify_wordpress.sh
```

### 5. Verify Deployment

After deploying changes, verify that the deployment was successful:

```bash
# Check ECS service status
aws ecs describe-services \
  --cluster wordpress-cluster \
  --services wordpress

# Verify WordPress is running
curl -I https://your-wordpress-url.com

# Check Datadog metrics for improvement
./scripts/check_metrics.sh
```

## Rollback Procedure

If issues are encountered after deployment, follow these steps to roll back:

### 1. Roll Back ECS Service

```bash
# Roll back to the previous task definition
aws ecs update-service \
  --cluster wordpress-cluster \
  --service wordpress \
  --task-definition wordpress:previous-version
```

### 2. Roll Back Infrastructure Changes

```bash
# Navigate to the infrastructure directory
cd setup/infrastructure

# Roll back to the previous state
terraform apply -var-file=production.tfvars -target=module.ecs -auto-approve
```

### 3. Verify Rollback

```bash
# Verify the rollback was successful
./scripts/verify_rollback.sh
```

## Continuous Deployment

For continuous deployment, consider implementing the following:

### 1. CI/CD Pipeline

Set up a CI/CD pipeline using AWS CodePipeline or GitHub Actions to automate the deployment process.

### 2. Blue/Green Deployment

Implement blue/green deployment for zero-downtime updates:

```bash
# Create a new task definition
aws ecs register-task-definition --cli-input-json file://new-task-def.json

# Update the service with the new task definition
aws ecs update-service \
  --cluster wordpress-cluster \
  --service wordpress \
  --task-definition wordpress:new-version \
  --deployment-configuration "minimumHealthyPercent=100,maximumPercent=200"
```

### 3. Automated Testing

Implement automated testing to verify the deployment:

```bash
# Run automated tests
./scripts/run_tests.sh

# Verify Datadog metrics
./scripts/verify_metrics.sh
```

## Deployment Best Practices

1. **Always back up data before deployment**
   ```bash
   ./scripts/backup_wordpress.sh
   ```

2. **Deploy during low-traffic periods**
   - Schedule deployments during off-peak hours
   - Monitor traffic patterns in Datadog before deploying

3. **Incremental changes**
   - Make small, incremental changes rather than large updates
   - Test each change thoroughly before proceeding

4. **Monitor closely after deployment**
   - Watch Datadog dashboards for any anomalies
   - Set up alerts for critical metrics
   - Have team members available for quick response

5. **Document all changes**
   - Keep a detailed log of all changes made
   - Update documentation to reflect new configurations
   - Share knowledge with the team